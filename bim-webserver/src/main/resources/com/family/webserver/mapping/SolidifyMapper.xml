<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.family.webserver.mapper.SolidifyMapper">
  <resultMap id="SolidifyResultMap" type="com.family.webserver.entity.Base">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="INTEGER" property="id"/>
  </resultMap>
  <insert id="merge_city_maoyan">
        INSERT INTO bim_base.city (id_maoyan, name, first_letter, pinyin)
            SELECT
        id,
                name,
                first_letter,
                pinyin
            FROM bim_web.city_maoyan b
        ON DUPLICATE KEY UPDATE id_maoyan = b.id;


    </insert>
  <insert id="merge_city_mtime">
        INSERT INTO bim_base.city (id_mtime, name, first_letter, pinyin)
            SELECT
        id,
                name,
                first_letter,
                pinyin
            FROM bim_web.city_mtime b
        ON DUPLICATE KEY UPDATE id_mtime = b.id;

    </insert>
  <insert id="merge_city_area_mtime">
        INSERT INTO bim_base.city_area (city_id, area)
        SELECT
        tmp.city_id,
        tmp.area
        FROM (
        SELECT
        c.id AS city_id,
        cim.city_id id_mtime,
        cim.area AS area
        FROM bim_web.cinema_mtime cim
        JOIN bim_base.city c ON c.id_mtime = cim.city_id
        GROUP BY cim.city_id, cim.area) tmp
        ON DUPLICATE KEY UPDATE area = tmp.area;
    </insert>

  <insert id="merge_city_area_maoyan">
        INSERT INTO bim_base.city_area (city_id, area)
            SELECT
                tmp.city_id,
                tmp.area
            FROM (
                     SELECT
                         c.id     AS city_id,
                         cim.city_id id_maoyan,
                         cim.area AS area
                     FROM bim_web.cinema_maoyan cim
                         JOIN bim_base.city c ON c.id_maoyan = cim.city_id
                     GROUP BY cim.city_id, cim.area) tmp
        ON DUPLICATE KEY UPDATE area = tmp.area;

    </insert>
  <insert id="merge_movieshowing_maoyan">
        INSERT INTO bim_base.movieshowing (id_maoyan, name, image, rating, is_imax, is_3d, directors, actors, type, content, runTime)
            SELECT
                id,
                name,
                image,
                rating,
                is_imax,
                is_3d,
                directors,
                actors,
                type,
                content,
                runTime
            FROM bim_web.movieshowing_maoyan my
        ON DUPLICATE KEY UPDATE id_maoyan = my.id;
    </insert>
  <insert id="merge_movieshowing_mtime">
        INSERT INTO bim_base.movieshowing (id_mtime, name, image, rating, is_imax, is_3d, directors, actors, type, content, runTime)
            SELECT
                id,
                name,
                image,
                rating,
                is_imax,
                is_3d,
                directors,
                actors,
                type,
                content,
                runTime
            FROM bim_web.movieshowing_mtime mm
        ON DUPLICATE KEY UPDATE id_maoyan = mm.id;
    </insert>
  <insert id="merge_cinema_mtime">
        INSERT INTO bim_base.cinema (id_mtime, district_id, name, address, latitude, longitude, rating, has_3d, has_imax, has_wifi, has_park, route, tel)

            SELECT
                cim.id,
                ca.id AS district_id,
                cim.name,
                address,
                latitude,
                longitude,
                rating,
                has_3d,
                has_imax,
                has_wifi,
                has_park,
                route,
                tel
            FROM bim_web.cinema_mtime cim
                JOIN bim_base.city ci ON cim.city_id = ci.id_mtime
                JOIN bim_base.city_area ca ON ca.area = cim.area AND ca.city_id = ci.id
        ON DUPLICATE KEY UPDATE id_mtime = cim.id, rating = cim.rating, has_3d = cim.has_3d, has_imax = cim.has_imax,
            has_wifi                     = cim.has_wifi, has_park = cim.has_park, route = cim.route, tel = cim.tel
    </insert>
  <insert id="merge_cinema_maoyan">
        INSERT INTO bim_base.cinema (id_maoyan, district_id, name, address, latitude, longitude, has_imax, tel)
            SELECT
                cim.id,
                ca.id AS district_id,
                cim.name,
                address,
                latitude,
                longitude,
                has_imax,
                tel
            FROM bim_web.cinema_maoyan cim

                JOIN bim_base.city c ON c.id_maoyan = cim.city_id
                JOIN bim_base.city_area ca ON ca.area = cim.area AND ca.city_id = c.id
        ON DUPLICATE KEY UPDATE id_maoyan = cim.id
    </insert>

  <delete id="deleteAllscreening">
        DELETE FROM bim_base.screening
    </delete>

  <insert id="merge_screening_maoyan">
        INSERT INTO bim_base.screening (cinema_id, movie_id, show_date, start_time, end_time, language, hall, version,
        sale_price, cinema_price, source, ticket_url)
            SELECT
                c.id AS cinema_id,
                m.id AS movie_id,
                show_date,
                start_time,
                end_time,
                language,
                hall,
        version,
        sale_price,
        cinema_price,
        'maoyan',
                ticket_url
        FROM bim_web.screening_maoyan pm
                JOIN bim_base.movieshowing m ON pm.movie_id = m.id_maoyan
                JOIN bim_base.cinema c ON pm.cinema_id = c.id_maoyan
        ON DUPLICATE KEY UPDATE ticket_url = pm.ticket_url
    </insert>

  <insert id="merge_screening_mtime">
        INSERT INTO bim_base.screening (cinema_id, movie_id, show_date, start_time, end_time, language, hall,
        version, sale_price, cinema_price, source, ticket_url)
        SELECT
        c.id AS cinema_id,
        m.id AS movie_id,
        show_date,
        start_time,
        end_time,
        language,
        hall,
        version,
        sale_price,
        cinema_price,
        'mtime',
        ticket_url
        FROM bim_web.screening_mtime pm
        JOIN bim_base.movieshowing m ON pm.movie_id = m.id_mtime
        JOIN bim_base.cinema c ON pm.cinema_id = c.id_mtime
        ON DUPLICATE KEY UPDATE ticket_url = pm.ticket_url
    </insert>
</mapper>
